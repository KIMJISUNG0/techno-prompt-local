import{r as u,j as e,a as B}from"./index-DpKukOXs.js";function F({className:r="",bars:t=48,showWave:i=!0}){const x=u.useRef(null),p=u.useRef(0),l=u.useRef([]),g=u.useRef(0);return u.useEffect(()=>{let f=!0;const h=x.current;if(!h)return;const n=h.getContext("2d",{alpha:!0});if(!n)return;function y(){if(!h||!n)return;const m=window.devicePixelRatio||1;h.width=h.clientWidth*m,h.height=h.clientHeight*m,n.setTransform(1,0,0,1,0,0),n.scale(m,m)}y(),window.addEventListener("resize",y);function k(m){var j,M,L,s;if(!f)return;if(m-p.current<33){requestAnimationFrame(k);return}p.current=m,window.liveAPICache||(window.liveAPI=window.liveAPI||null);let b=null;try{window.lastLiveAPI?b=(M=(j=window.lastLiveAPI).getAnalyser)==null?void 0:M.call(j):window.getLiveAPI&&(b=(s=(L=window.getLiveAPI()).getAnalyser)==null?void 0:s.call(L))}catch{}if(b&&h&&n){const c=b.freq;n.clearRect(0,0,h.width,h.height);const a=h.clientWidth,o=h.clientHeight,P=Math.floor(c.length/t)||1,N=a/t;l.current.length!==t&&(l.current=new Array(t).fill(0));for(let d=0;d<t;d++)l.current[d]*=.92;for(let d=0;d<t;d++){const C=c[d*P]/255;C>l.current[d]&&(l.current[d]=C);const v=l.current[d],R=C*o*.75,w=d*N,S=180+d/t*140,A=n.createLinearGradient(w,o-R,w,o);A.addColorStop(0,`hsla(${S},85%,65%,0.70)`),A.addColorStop(1,`hsla(${S+40},90%,45%,0.05)`),n.fillStyle=A;const G=Math.min(6,N*.35),_=o-R;O(n,w+N*.15,_,N*.7,R,G);const q=o-v*o*.75;n.fillStyle=`hsla(${S},90%,80%,0.45)`,n.fillRect(w+N*.32,q-2,N*.36,2)}if(i){const d=b.time;n.globalCompositeOperation="lighter",n.lineWidth=1.4,n.strokeStyle="rgba(255,255,255,0.16)",n.beginPath();const C=o*.55;for(let v=0;v<d.length;v++){const w=v/(d.length-1)*a,S=(d[v]-128)/128,A=C+S*o*.22;v===0?n.moveTo(w,A):n.lineTo(w,A)}n.stroke(),n.globalCompositeOperation="source-over"}const E=n.createRadialGradient(a*.5,o*.65,o*.2,a*.5,o*.65,o*.9);E.addColorStop(0,"rgba(255,255,255,0)"),E.addColorStop(1,"rgba(5,7,13,0.9)"),n.fillStyle=E,n.fillRect(0,0,a,o),g.current>.01&&(g.current*=.9,n.fillStyle=`rgba(255,255,255,${g.current*.15})`,n.fillRect(0,0,a,o))}requestAnimationFrame(k)}requestAnimationFrame(k);const T=m=>{g.current=1};return window.addEventListener("liveaudio.hit",T),()=>{f=!1,window.removeEventListener("resize",y)}},[t,i]),e.jsx("canvas",{ref:x,className:"absolute inset-0 w-full h-full "+r})}function O(r,t,i,x,p,l){r.beginPath(),r.moveTo(t+l,i),r.lineTo(t+x-l,i),r.quadraticCurveTo(t+x,i,t+x,i+l),r.lineTo(t+x,i+p-l),r.quadraticCurveTo(t+x,i+p,t+x-l,i+p),r.lineTo(t+l,i+p),r.quadraticCurveTo(t,i+p,t,i+p-l),r.lineTo(t,i+l),r.quadraticCurveTo(t,i,t+l,i),r.closePath(),r.fill()}const H=/(document|fetch|XMLHttpRequest|localStorage|Function|eval|globalThis)/g,$=["setBPM","setSwing","play","update","stop","stopAll","list","registerPatch","triggerPatch","listPatches","log","tonePlay","toneStop","toneStopAll","listTone","setToneBPM","tonePatternPlay","tonePatternStop","tonePatternStopAll"];function z(){const r=B(),t={};for(const i of $)t[i]=r[i];return t}function I(r){try{if(H.test(r))return{ok:!1,error:"Disallowed identifier in code."};const t=z(),i=/\b(?:const|let|var)\s+api\b/.test(r),x=Object.keys(t),p=x.map(f=>t[f]);let l=`"use strict";
`;return i||(x.push("__sandbox_api"),p.push(t),l+=`const api = __sandbox_api;
`),new Function(...x,l+r+`
`)(...p),{ok:!0}}catch(t){return{ok:!1,error:(t==null?void 0:t.message)||String(t)}}}function K({onClose:r}){const[t,i]=u.useState(`// Live coding playground
setBPM(128)
play('kick',{ pattern:'x---x---x---x---' })`),[x,p]=u.useState([]),[l,g]=u.useState("code"),[f,h]=u.useState(!1),[n,y]=u.useState(0),[k,T]=u.useState(1);u.useEffect(()=>{let s,c=!0;function a(){try{const o=window.liveAPI;if(f&&(o!=null&&o.getMicAnalyser)){const P=o.getMicAnalyser();(P==null?void 0:P.level)!=null&&y(P.level)}}catch{}c&&(s=requestAnimationFrame(a))}return a(),()=>{c=!1,cancelAnimationFrame(s)}},[f]);async function m(){const s=window.liveAPI;s&&(f?(s.disableMic(),h(!1),y(0),j("Mic disabled","info")):await s.enableMic()?(h(!0),j("Mic enabled","info")):j("Mic permission denied","error"))}function b(s){var a;T(s);const c=window.liveAPI;(a=c==null?void 0:c.setMicGain)==null||a.call(c,s)}u.useEffect(()=>{function s(c){var a;(a=c.detail)!=null&&a.snippet&&(i(o=>o+(o.endsWith(`
`)?"":`
`)+c.detail.snippet+`
`),j("Inserted snippet","info"))}return window.addEventListener("livecode.insert",s),()=>window.removeEventListener("livecode.insert",s)},[]);function j(s,c){p(a=>[...a.slice(-199),{ts:Date.now(),text:s,type:c}])}function M(){const s=I(t);s.ok?j("Run OK","info"):j("Error: "+s.error,"error")}function L(){I("stopAll()").ok&&j("Stopped all","info")}return e.jsxs("div",{className:"flex flex-col h-full bg-black/60 border-l border-white/10 relative overflow-hidden",children:[e.jsx(F,{bars:48,className:"opacity-40 mix-blend-plus-lighter pointer-events-none"}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-white/10",children:[e.jsxs("div",{className:"flex gap-2 text-[11px]",children:[e.jsx("button",{onClick:()=>g("code"),className:`px-2 py-1 rounded ${l==="code"?"bg-cyan-600/30 text-cyan-200":"text-slate-400 hover:text-cyan-200"}`,children:"Code"}),e.jsx("button",{onClick:()=>g("help"),className:`px-2 py-1 rounded ${l==="help"?"bg-cyan-600/30 text-cyan-200":"text-slate-400 hover:text-cyan-200"}`,children:"Help"})]}),e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[10px]",children:[e.jsx("button",{onClick:m,className:`px-2 py-1 rounded border text-[10px] ${f?"border-slate-400 text-slate-200 bg-white/10 hover:bg-white/20":"border-slate-600 text-slate-400 hover:border-slate-400"}`,children:f?"Mic On":"Mic Off"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-slate-500",children:"Gain"}),e.jsx("input",{type:"range",min:0,max:3,step:.05,value:k,onChange:s=>b(parseFloat(s.target.value)),className:"accent-slate-400"})]}),e.jsx("div",{className:"w-14 h-2 bg-slate-800/60 rounded overflow-hidden",children:e.jsx("div",{style:{width:`${Math.min(100,Math.round(n*140))}%`},className:"h-full bg-slate-300 transition-all"})})]}),e.jsx("button",{onClick:M,className:"px-3 py-1.5 rounded bg-emerald-600/30 border border-emerald-400/40 text-[11px] hover:bg-emerald-600/40",children:"Run"}),e.jsx("button",{onClick:L,className:"px-3 py-1.5 rounded bg-rose-600/20 border border-rose-400/40 text-[11px] hover:bg-rose-600/30",children:"Stop"}),r&&e.jsx("button",{onClick:r,className:"px-2 text-slate-400 hover:text-cyan-200 text-[11px]",children:"×"})]})]}),l==="code"&&e.jsxs("div",{className:"flex flex-col md:flex-row flex-1 overflow-hidden",children:[e.jsx("div",{className:"w-full md:w-1/2 flex flex-col border-b md:border-b-0 md:border-r border-white/10",children:e.jsx("textarea",{value:t,onChange:s=>i(s.target.value),spellCheck:!1,className:"flex-1 bg-black/40 p-3 font-mono text-[11px] text-slate-200 outline-none resize-none"})}),e.jsxs("div",{className:"w-full md:w-1/2 flex flex-col",children:[e.jsx("div",{className:"text-[10px] uppercase tracking-wider px-2 py-1 text-slate-400 border-b border-white/5",children:"Log"}),e.jsx("div",{className:"flex-1 overflow-auto p-2 space-y-1 text-[11px] font-mono",children:x.map(s=>e.jsx("div",{className:s.type==="error"?"text-rose-300":"text-slate-300",children:s.text},s.ts+Math.random()))})]})]}),l==="help"&&e.jsxs("div",{className:"p-3 text-[11px] leading-relaxed text-slate-300 overflow-auto space-y-5",children:[e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"Core API"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1",children:[e.jsxs("li",{children:[e.jsx("code",{children:"setBPM(n)"})," / ",e.jsx("code",{children:"setSwing(pct)"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"play()"}),", ",e.jsx("code",{children:"update()"}),", ",e.jsx("code",{children:"stop()"}),", ",e.jsx("code",{children:"stopAll()"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"registerPatch()"}),", ",e.jsx("code",{children:"triggerPatch()"}),", ",e.jsx("code",{children:"listPatches()"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"tonePlay()"}),", ",e.jsx("code",{children:"tonePatternPlay()"}),", ",e.jsx("code",{children:"toneStop()"}),","," ",e.jsx("code",{children:"toneStopAll()"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"setToneBPM()"}),", ",e.jsx("code",{children:"getAnalyser()"}),", ",e.jsx("code",{children:"liveaudio.hit"})]})]})]}),e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"Pattern DSL v2"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1 text-slate-400",children:[e.jsxs("li",{children:["Notes: ",e.jsx("code",{children:"C4"}),", ",e.jsx("code",{children:"D#3"})," 등"]}),e.jsxs("li",{children:["Rest: ",e.jsx("code",{children:"."})," 또는 ",e.jsx("code",{children:"-"})]}),e.jsxs("li",{children:["Hold: ",e.jsx("code",{children:"_"})," 이전 노트 길이 +1 (누적 길이)"]}),e.jsxs("li",{children:["Velocity: ",e.jsx("code",{children:"!"})," (accent) / ",e.jsx("code",{children:"?"})," (soft)"]})]}),e.jsx("pre",{className:"bg-black/30 p-2 rounded border border-white/5 whitespace-pre-wrap",children:`setToneBPM(128)
tonePatternPlay('arp','C4_E4.G4!_B4.-C5?', { type:'synth', velocity:0.85 })`})]}),e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"FX Customization"}),e.jsx("pre",{className:"bg-black/30 p-2 rounded border border-white/5 whitespace-pre-wrap",children:"tonePlay('pad',{ type:'synth', notes:['C3','E3','G3','B3'], fx:[{ type:'reverb', decay:4.2, wet:0.4 }] })"})]}),e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"Analyser & Events"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1 text-slate-400",children:[e.jsxs("li",{children:[e.jsx("code",{children:"getAnalyser()"})," → ","{ freq,time,level }"]}),e.jsxs("li",{children:[e.jsx("code",{children:"liveaudio.hit"})," → ",e.jsx("code",{children:"detail.role / velocity"})]})]})]}),e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"Patch & Update"}),e.jsx("pre",{className:"bg-black/30 p-2 rounded border border-white/5 whitespace-pre-wrap",children:`registerPatch('HardKick',{ type:'kick', pattern:'x---x---x---x---', base:{ gain:0.95 } })
triggerPatch('HardKick')
play('hat',{ pattern:'-x-x-x-x-x-x-x-x', gain:0.3 })
update('hat',{ gain:0.22 })`})]}),e.jsxs("section",{children:[e.jsx("div",{className:"mb-1 font-semibold text-cyan-200",children:"New Band Instruments"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-1 text-slate-400",children:[e.jsxs("li",{children:[e.jsx("code",{children:"guitar"})," (Karplus-Strong pluck) –"," ",e.jsx("code",{children:"play('gtr',{ type:'guitar', pattern:'x---x---x---x---', notes:[52,55,59,55] })"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"bassGtr"})," (low saw + LP) –"," ",e.jsx("code",{children:"play('bassG',{ type:'bassGtr', pattern:'x---x---x---x---', notes:[36,36,43,31] })"})]}),e.jsxs("li",{children:[e.jsx("code",{children:"piano"})," (additive partials) – env attack/decay/release 적용"]}),e.jsxs("li",{children:[e.jsx("code",{children:"organ"})," (sine harmonics sustain)"]}),e.jsxs("li",{children:[e.jsx("code",{children:"tom"})," (pitch sweep)"]}),e.jsxs("li",{children:[e.jsx("code",{children:"clap"})," (multi burst noise)"]}),e.jsxs("li",{children:[e.jsx("code",{children:"ride"})," (bandpass noise long decay)"]})]})]})]})]})}export{K as L};
