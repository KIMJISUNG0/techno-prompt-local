<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPS v4.3 (Data Expansion)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --ac: 234 89% 72%; --surf: 0 0% 100%/0.06; --bd: 0 0% 100%/0.12; color-scheme: dark; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        .glass { background: hsl(var(--surf)); -webkit-backdrop-filter: saturate(180%) blur(16px); backdrop-filter: saturate(180%) blur(16px); border: 1px solid hsl(var(--bd)); }
        .chip { padding: .45rem .75rem; border-radius: 12px; font-size: .9rem; border: 1px solid rgba(255, 255, 255, .12); background: rgba(255, 255, 255, .06); transition: .12s; }
        .chip[data-selected=true] { background: rgba(255, 255, 255, .22); border-color: rgba(255, 255, 255, .28); }
        .iconbtn { background: rgba(255, 255, 255, .08); border: 1px solid rgba(255, 255, 255, .14); }
        #bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(1200px 800px at 50% 40%, #0a0a12 0%, #06060a 45%, #010108 100%); cursor: default; }
        .field { display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .6rem .9rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(255, 255, 255, .06); }
        .field span { opacity: .9; }
        .field .mini { opacity: .7; font-size: .85rem; }
        .toast { position: fixed; inset: auto 0 20px 0; display: grid; place-items: center; pointer-events: none; }
        .toast>div { pointer-events: auto; }
        .loader { border: 2px solid rgba(255,255,255,0.2); border-top-color: hsl(var(--ac)); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-neutral-950 text-white min-h-[100svh]">
    <canvas id="bg"></canvas>
    <div class="max-w-5xl mx-auto px-4">
        <header class="glass rounded-2xl px-4 md:px-6 py-4 mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="size-8 rounded-xl bg-white/10 grid place-items-center" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12c3 0 3-6 6-6s3 12 6 12 3-6 6-6" stroke="hsl(var(--ac))" stroke-width="1.8" stroke-linecap="round" /></svg></div>
                <h1 class="text-lg md:text-xl font-semibold tracking-tight">Suno Prompt Studio</h1>
            </div>
            <div class="inline-flex bg-white/5 rounded-xl p-1" role="tablist" aria-label="Mode switch">
                <button id="seg-ai" class="px-3 md:px-4 py-1.5 rounded-lg text-sm font-medium data-[active=true]:bg-white/20" data-active="true" aria-selected="true" role="tab">AI ê°€ì´ë“œ</button>
                <button id="seg-pro" class="px-3 md:px-4 py-1.5 rounded-lg text-sm font-medium" role="tab">í”„ë¡œ ìŠ¤íŠœë””ì˜¤</button>
            </div>
        </header>
        <div class="grid min-h-[calc(100svh-120px)] place-items-center group">
            <div class="grid grid-cols-[auto,1fr,auto] items-stretch gap-2 w-full">
                <button id="nav-left" class="opacity-0 group-hover:opacity-100 glass rounded-xl w-12 md:w-14 grid place-items-center" aria-label="ì´ì „ ë‹¨ê³„"><span class="text-2xl">&lt;</span></button>
                <main class="glass rounded-2xl p-4 md:p-6">
                    <div id="progress-wrap" class="mb-4">
                        <div class="h-1.5 bg-white/10 rounded-full overflow-hidden"><div id="progress" class="h-1.5 bg-[hsl(var(--ac))] w-0"></div></div>
                    </div>
                    <section id="view" class="space-y-5"></section>
                    <section id="result" class="mt-5"></section>
                </main>
                <button id="nav-right" class="opacity-0 group-hover:opacity-100 glass rounded-xl w-12 md:w-14 grid place-items-center" aria-label="ë‹¤ìŒ ë‹¨ê³„"><span class="text-2xl">&gt;</span></button>
            </div>
        </div>
        <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50"><div class="absolute inset-0 bg-black/55 backdrop-blur-sm"></div><div class="relative glass rounded-2xl p-5 w-[min(92vw,860px)]"><h3 id="mt" class="text-lg font-semibold text-center"></h3><div class="mt-3"><input id="mSearch" placeholder="ì•…ê¸°, ì‚¬ìš´ë“œ, ì£¼ë²• ë“± ê²€ìƒ‰..." class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm" /></div><div id="mg" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto mt-3"></div><div class="mt-4 grid grid-cols-2 gap-2"><button id="mOK" class="bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 text-sm font-medium">ì„ íƒ 0ê°œ ì¶”ê°€</button><button id="mX" class="bg-white/10 hover:bg-white/15 rounded-xl py-2.5 text-sm">ë‹«ê¸°</button></div></div></div>
        <div id="toast" class="toast"></div>
    </div>
    <script>
    (function(){
        'use strict';
        const PROXY_ENDPOINT = '/api/gemini';

        // --- STARFIELD & ORBITING EMOJIS ---
        const bg = document.getElementById('bg'), g = bg.getContext('2d');
        let W, H, CX, CY, stars = [];
        const R = () => { W = bg.width = innerWidth; H = bg.height = innerHeight; CX = W/2; CY = H/2 }; addEventListener('resize', R); R();
        function initStars(n=340){ stars = new Array(n).fill(0).map(()=>({x:Math.random()*2-1,y:Math.random()*2-1,z:Math.random()*0.8+0.2,len:Math.random()*0.008+0.002})) } initStars();
        const spaceBuddies=[{emoji:'ğŸˆ',t:0,speed:.0022,orbitX:.35,orbitY:.22,orbitZ:.4},{emoji:'ğŸ§‘â€ğŸš€',t:1.5,speed:.0018,orbitX:.4,orbitY:.25,orbitZ:.5},{emoji:'ğŸ•',t:3,speed:.0025,orbitX:.3,orbitY:.2,orbitZ:.3},{emoji:'ğŸ¥¦',t:4.5,speed:.002,orbitX:.38,orbitY:.23,orbitZ:.45}];
        bg.addEventListener('click',(e)=>{const rect=bg.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;const s=Math.min(W,H)*.55;spaceBuddies.forEach(b=>{if(b.isFlicked)return;const x=Math.cos(b.t)*b.orbitX,y=Math.sin(b.t*0.7)*b.orbitY,z=.58+.13*Math.sin(b.t*b.orbitZ);const sx=CX+(x/z)*s,sy=CY+(y/z)*s,px=16+(1-z)*26;const dist=Math.hypot(mx-sx,my-sy);if(dist<px){b.isFlicked=true;b.flickX=sx;b.flickY=sy;b.flickVx=(Math.random()-0.5)*40;b.flickVy=(Math.random()-0.5)*40}})});
        function drawBuddies(){const s=Math.min(W,H)*.55;spaceBuddies.forEach(b=>{let sx,sy,px; if(b.isFlicked){b.flickX+=b.flickVx;b.flickY+=b.flickVy;b.flickVx*=.99;b.flickVy*=.99;sx=b.flickX;sy=b.flickY;px=30;if(sx<-50||sx>W+50||sy<-50||sy>H+50)b.isFlicked=false;}else{b.t+=b.speed;const x=Math.cos(b.t)*b.orbitX,y=Math.sin(b.t*0.7)*b.orbitY,z=.58+.13*Math.sin(b.t*b.orbitZ);sx=CX+(x/z)*s;sy=CY+(y/z)*s;px=16+(1-z)*26;}g.save();g.font=`${px}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui`;g.textAlign='center';g.textBaseline='middle';g.fillText(b.emoji,sx,sy);g.restore();})}
        const SPEED=.006; (function tick(){g.clearRect(0,0,W,H);g.save();g.lineCap='round';const s=Math.min(W,H)*.55;for(const st of stars){st.z-=SPEED;if(st.z<=.02){st.x=Math.random()*2-1;st.y=Math.random()*2-1;st.z=1}const sx=CX+(st.x/st.z)*s,sy=CY+(st.y/st.z)*s,psx=CX+(st.x/(st.z+st.len))*s,psy=CY+(st.y/(st.z+st.len))*s,a=1-Math.min(1,st.z);g.strokeStyle=`rgba(255,255,255,${.12+a*.55})`;g.lineWidth=1+(1-st.z)*1.8;g.beginPath();g.moveTo(psx,psy);g.lineTo(sx,sy);g.stroke()}drawBuddies();g.restore();requestAnimationFrame(tick)})();

        // --- DOM REFS & HELPERS ---
        const view=document.getElementById('view'), result=document.getElementById('result'), segAI=document.getElementById('seg-ai'), segPRO=document.getElementById('seg-pro'), pl=document.getElementById('progress'), pw=document.getElementById('progress-wrap'), navL=document.getElementById('nav-left'), navR=document.getElementById('nav-right'), modal=document.getElementById('modal'), mt=document.getElementById('mt'), mg=document.getElementById('mg'), mOK=document.getElementById('mOK'), mX=document.getElementById('mX'), mSearch=document.getElementById('mSearch'), toast=document.getElementById('toast');
        const Chip=(t,sel,fn)=>{const b=document.createElement('button');b.className='chip';b.dataset.selected=sel;b.textContent=t;b.onclick=fn;return b};
        function pills(list,selected,set){const wrap=document.createElement('div');wrap.className='flex flex-wrap gap-2 mt-3';list.forEach(n=>wrap.appendChild(Chip(n,selected.has?selected.has(n):selected===n,(e)=>{if(selected.has){selected.has(n)?selected.delete(n):selected.add(n);e.target.dataset.selected=selected.has(n)}else{set(n);[...wrap.children].forEach(c=>c.dataset.selected=false);e.target.dataset.selected=true}})));return wrap}
        function showToast(msg){const el=document.createElement('div');el.className='glass rounded-xl px-3 py-2 text-sm max-w-[90vw]';el.textContent=msg;toast.appendChild(el);setTimeout(()=>el.remove(),1500)}
        let ctx=null;function openModal({title,list,multi=false,onDone,placeholder='ê²€ìƒ‰...'}){ctx={multi,onDone,all:list,sel:new Set(),view:new Set(list)};mt.textContent=title;mSearch.placeholder=placeholder;renderModal();modal.classList.add('grid');modal.classList.remove('hidden')} function renderModal(){mg.innerHTML="";[...ctx.view].forEach(n=>{const b=Chip(n,false,()=>{if(!ctx.multi){ctx.sel=new Set([n]);finishModal();return}const on=b.dataset.selected==='true';b.dataset.selected=!on;on?ctx.sel.delete(n):ctx.sel.add(n);mOK.textContent=`ì„ íƒ ${ctx.sel.size}ê°œ ì¶”ê°€`});mg.appendChild(b)});mSearch.oninput=()=>{const q=mSearch.value.toLowerCase().trim();ctx.view=new Set(ctx.all.filter(x=>x.toLowerCase().includes(q)));renderModal()};mOK.textContent=ctx.multi?`ì„ íƒ ${ctx.sel.size}ê°œ ì¶”ê°€`:'ì„ íƒ';mOK.onclick=finishModal;mX.onclick=()=>modal.classList.add('hidden')} function finishModal(){modal.classList.add('hidden');if(ctx.onDone){ctx.onDone(ctx.multi?Array.from(ctx.sel):Array.from(ctx.sel)[0])}}

        // --- Gemini API (Proxy) ---
        async function callGeminiAPI(localPrompt){ if(!localPrompt||!localPrompt.trim()) return 'í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'; try{ const res=await fetch(PROXY_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:localPrompt})}); const data=await res.json().catch(()=>({})); if(!res.ok) return `ì„œë²„ ì˜¤ë¥˜: ${data.error||res.status}`; return data.text?.replace(/[*#]/g,'')||'Gemini ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';}catch(e){return 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: '+e.message;} }

        // --- DATA (Expanded) ---
        const genreMap={'Funk':['Funk (General)','Soul Funk','Neo-Soul','G-Funk','Acid Jazz','Psychedelic Funk'],'Jazz':['Jazz (General)','Bebop','Cool Jazz','Swing','Fusion','Modal Jazz'],'K-Pop':['K-Pop (General)','Dance-Pop','K-Hip Hop','K-Ballad','K-R&B'],'J-Pop':['J-Pop (General)','City Pop','Shibuya-kei','J-Rock','Anime Song'],'Synthpop':['Synthpop (General)','Synthwave','Futurepop','Darkwave','Chillwave'],'Rock':['Rock (General)','Classic Rock','Alternative Rock','Indie Rock','Punk Rock','Heavy Metal','Post-Punk'],'Hip Hop':['Hip Hop (General)','Trap','Boom Bap','Lo-fi Hip Hop','Drill','Cloud Rap'],'EDM':['EDM (General)','House','Deep House','Tech House','Progressive House','Techno','Trance','Dubstep','Future Bass'],'Drum & Bass':['Drum & Bass (General)','Liquid DnB','Neurofunk','Jump-Up','Jungle','Deep DnB','Atmospheric','Minimal','Halftime'],'R&B':['R&B (General)','Contemporary R&B','Neo-Soul','Alternative R&B','Quiet Storm'],'Ballad':['Ballad (General)','Pop Ballad','Rock Ballad','Soul Ballad']};
        const aiState={step:1,genre:'Funk',sub:'Funk (General)',core:new Set(['Drums','Bass','Piano']),perk:new Set(['Shaker']),vocal:'Female Vocal',vocalTone:new Set([]),keywords:"",mood:new Set(['Warm','Dreamy']),bpm:110,structure:new Set(['Intro','Verse','Chorus']),bracket:true,emphasis:false};
        function aiTotal(){return 7}
        function field(label,value,onclick){const d=document.createElement('button');d.type='button';d.className='field w-full text-left';d.onclick=onclick;d.innerHTML=`<span>${label}</span><span class="mini">${value}</span>`;return d}
        function renderAI(){view.innerHTML="";pw.style.display='block';pl.style.width=((aiState.step/aiTotal())*100)+'%';navL.style.visibility=aiState.step===1?'hidden':'visible';navR.style.visibility=aiState.step===aiTotal()?'hidden':'visible';const card=document.createElement('div');card.className='space-y-4';const H=t=>{const h=document.createElement('h3');h.className='text-base font-semibold';h.textContent=t;return h};if(aiState.step===1){card.appendChild(H('Step 1: ì¥ë¥´ ì„ íƒ'));card.appendChild(field(`ì¥ë¥´`,`${aiState.genre} @${aiState.bpm}bpm`,()=>openModal({title:'GENRE ì„ íƒ',list:Object.keys(genreMap),multi:false,onDone:pick=>{if(!pick)return;aiState.genre=pick;aiState.sub=genreMap[pick][0];aiState.bpm=(pick==='Drum & Bass')?174:aiState.bpm;renderAI()}})))} if(aiState.step===2){card.appendChild(H('Step 2: ì„¸ë¶€ ì¥ë¥´ ì„ íƒ'));card.appendChild(field('ì„¸ë¶€ ì¥ë¥´',aiState.sub,()=>openModal({title:'SUBGENRE ì„ íƒ',list:genreMap[aiState.genre],multi:false,onDone:pick=>{if(!pick)return;aiState.sub=pick;renderAI()}})))} if(aiState.step===3){card.appendChild(H('Step 3: í•µì‹¬ì•…ê¸° êµ¬ì„±'));let items=['Drums','Bass','Guitar','Piano','Synthesizer','Strings','Contrabass','Saxophone'];if(aiState.genre==='Drum & Bass'){items=['Drums','Reese Bass','Sub Bass','FM Growl','Wobble Lead','Pads','Atmos Pad','Arp Synth']}card.appendChild(pills(items,aiState.core))} if(aiState.step===4){card.appendChild(H('Step 4: í¼ì»¤ì…˜ & FX'));let items=['Bongo','Conga','Tambourine','Shaker','Claves','Riser','Impact','White Noise','Vinyl Crackle'];if(aiState.genre==='Drum & Bass'){items=['Riser','Downlifter','White Noise','Reverb Tail','Noise Sweep','Snare Roll','Reverse Cymbal']}card.appendChild(pills(items,aiState.perk))} if(aiState.step===5){card.appendChild(H('Step 5: ë³´ì»¬ & í‚¤ì›Œë“œ'));const row=document.createElement('div');row.className='grid grid-cols-1 md:grid-cols-2 gap-3 mt-2';const vocList=aiState.genre==='Drum & Bass'?['Instrumental','Vocal Chop','Male Vocal','Female Vocal']:['Male Vocal','Female Vocal','Instrumental'];const vocWrap=field('ë³´ì»¬',aiState.vocal,()=>openModal({title:'VOCAL ì„ íƒ',list:vocList,multi:false,onDone:pick=>{if(pick)aiState.vocal=pick;renderAI()}}));const kw=document.createElement('input');kw.placeholder='ë…¸ë˜ ì£¼ì œ í‚¤ì›Œë“œ';kw.value=aiState.keywords||'';kw.className='w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2';kw.oninput=()=>aiState.keywords=kw.value;row.appendChild(vocWrap);row.appendChild(kw);card.appendChild(row)} if(aiState.step===6){card.appendChild(H('Step 6: ë¬´ë“œ, BPM, êµ¬ì¡°'));const moodsBase=['Warm','Dreamy','Groovy','Dark','Sparkly','Vintage'];const dnbMoods=['Euphoric','Atmospheric','Neuro','Liquid','Rollers'];const moodList=aiState.genre==='Drum & Bass'?moodsBase.concat(dnbMoods):moodsBase;card.appendChild(pills(moodList,aiState.mood));const ctrl=document.createElement('div');ctrl.className='grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3';const bpmDefault=aiState.genre==='Drum & Bass'?174:aiState.bpm;ctrl.innerHTML=`<label class='block text-sm'>BPM <input id='bpm' type='number' value='${bpmDefault}' class='mt-1 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2'></label><label class='block text-sm sm:col-span-2'>êµ¬ì¡° <span class='block text-[11px] text-neutral-400 mt-1'>Intro, Drop, Break, Build, Outro ë“±</span></label>`;aiState.bpm=bpmDefault;card.appendChild(ctrl);ctrl.querySelector('#bpm').oninput=e=>aiState.bpm=+e.target.value||bpmDefault;const structList=aiState.genre==='Drum & Bass'?['Intro','Build','Drop','Roller','Break','Second Drop','Outro']:['Intro','Verse','Pre-Chorus','Chorus','Bridge','Breakdown','Outro'];card.appendChild(pills(structList,aiState.structure))} if(aiState.step===7){card.appendChild(H('Step 7: í”„ë¡¬í”„íŠ¸ ìƒì„±'));const btn=document.createElement('button');btn.className='w-full bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 font-medium';btn.textContent='âœ¨ í”„ë¡¬í”„íŠ¸ ìƒì„±';btn.onclick=()=>{const prompt=buildAIPrompt();showResult(prompt,'ai',btn)};card.appendChild(btn)} view.appendChild(card)}
        function buildAIPrompt(){const join=s=>Array.from(s||[]).join(', ');const nonEmpty=a=>a.filter(Boolean);const head=`GENRE: ${aiState.genre}/${aiState.sub} @${aiState.bpm}bpm`;const lines=[head];const core=join(aiState.core);if(core)lines.push(`CORE: ${core}`);const perk=join(aiState.perk);if(perk)lines.push(`PERC/FX: ${perk}`);if(aiState.vocal&&aiState.vocal!=='Instrumental'){const tone=join(aiState.vocalTone);lines.push(`VOCAL: ${aiState.vocal}${tone?` (${tone} voice)`:''}`)}const mood=join(aiState.mood);if(mood)lines.push(`MOOD: ${mood}`);const struct=Array.from(aiState.structure||[]);if(struct.length){lines.push(`STRUCT: ${aiState.bracket?struct.map(s=>`[${s}]`).join(' '):struct.join(' > ')}`)} if(aiState.keywords&&aiState.keywords.trim())lines.push(`THEME: ${aiState.keywords.trim()}`);return nonEmpty(lines).join(' | ')}

        // PRO Mode Data
        const tracks={rhythm:['DnB 174 Straight'],bass:[],harmony:[],lead:[],percussion:[],fx:[],kick:['Punchy DnB Kick'],snare:['Snappy DnB Snare'],hihat:['Shuffling Hat'],clap:[],cymbal:[],mix:[],mast:[]};
        const lib={rhythm:['Four-on-the-floor','Half-time Trap','Boom Bap Swing 56%','Dilla Swing 58%','Funk Shuffle 16th','Disco Shuffle','Breakbeat 130bpm','Reggaeton Dembow','Bossa Nova','Samba','Afrobeat Groove','House Shuffle','Techno Straight 16th','Garage Skip','Latin Clave 3-2','Latin Clave 2-3','DnB 174 Straight','DnB 174 Swing 52%','Jungle 165','Halftime 85','Neurofunk 172'],bass:['Electric Bass (Finger)','Electric Bass (Pick)','Slap Bass','Synth Bass','808 Bass','Contrabass','Reese Bass','Sub Sine','FM Growl','Wobble Bass','Neuro Bass'],harmony:['Piano','Electric Piano','Organ','Synth Pad','String Section','Rhythm Guitar','Atmos Pad','Chords Stab'],lead:['Lead Guitar','Synth Lead','Saxophone','Trumpet','Violin','Flute','Wobble Lead','Pluck Lead','Arp Synth'],percussion:['Bongo','Conga','Tambourine','Shaker','Claves','Snare Roll','Reverse Cymbal'],fx:['Riser','Impact','White Noise','Vinyl Crackle','Downlifter','Reverb Tail'],kick:['808 Kick','909 Kick','Linn Kick','Acoustic Kick Soft','Acoustic Kick Hard','Punchy DnB Kick','Tight 909 Kick','Subby Kick'],snare:['808 Snare','909 Snare','Linn Snare','Acoustic Snare Brush','Acoustic Snare Crack','Snappy DnB Snare','Rimshot Crack','Layered Snare 909'],hihat:['Closed Hat 808','Open Hat 808','Closed Hat 909','Open Hat 909','Acoustic Hat Tight','Acoustic Hat Loose','Shuffling Hat','16th Hat Tight','Open Hat Splash'],clap:['808 Clap','909 Clap','Handclap','Layered Clap'],cymbal:['Crash Bright','Crash Dark','Ride Ping','Ride Wash'],mix:['Sidechain: Kick-Bass','Drum BusComp: Punchy'],mast:['LUFS: -8','Width: 15%']};
        function openKit(cat){openModal({title:`${cat.toUpperCase()} í•­ëª© ì„ íƒ`,list:lib[cat]||[],multi:true,onDone:arr=>{(tracks[cat]||(tracks[cat]=[]));arr.forEach(n=>tracks[cat].push(n));renderPRO()}})}
        function box(cat,label){const d=document.createElement('div');d.className='glass rounded-2xl p-4';d.innerHTML=`<div class='flex items-center justify-between mb-2'><h4 class='font-medium'>${label}</h4><button class='add bg-[hsl(var(--ac))]/20 hover:bg-[hsl(var(--ac))]/30 rounded-lg px-3 py-1.5 text-sm'>+ ì„ íƒ ì¶”ê°€</button></div><div class='space-y-2 list'></div>`;const list=d.querySelector('.list');d.querySelector('.add').onclick=()=>openKit(cat);const refresh=()=>{list.innerHTML='';(tracks[cat]||[]).forEach((n,i)=>{const r=document.createElement('div');r.className='flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-3 py-2';r.innerHTML=`<span>${n}</span>`;const del=document.createElement('button');del.className='text-red-300/90 hover:text-red-200 text-sm';del.textContent='ì‚­ì œ';del.onclick=()=>{tracks[cat].splice(i,1);refresh()};r.appendChild(del);list.appendChild(r)})};refresh();return d}
        function renderPRO(){view.innerHTML="";pw.style.display='none';navL.style.visibility='hidden';navR.style.visibility='hidden';const wrap=document.createElement('div');wrap.className='grid grid-cols-1 lg:grid-cols-2 gap-4';const left=document.createElement('div');left.className='space-y-4';const right=document.createElement('div');right.className='space-y-4';['rhythm','bass','harmony'].forEach(k=>left.appendChild(box(k,{rhythm:'ë¦¬ë“¬',bass:'ë² ì´ìŠ¤',harmony:'í•˜ëª¨ë‹ˆ'}[k],k)));['lead','percussion','fx','kick','snare','hihat','clap','cymbal','mix','mast'].forEach(k=>right.appendChild(box(k,{lead:'ë¦¬ë“œ',percussion:'í¼ì»¤ì…˜',fx:'FX',kick:'í‚¥',snare:'ìŠ¤ë„¤ì–´',hihat:'í•˜ì´í–‡',clap:'í´ë©',cymbal:'ì‹¬ë²Œ',mix:'ë¯¹ì‹±',mast:'ë§ˆìŠ¤í„°ë§'}[k],k)));wrap.appendChild(left);wrap.appendChild(right);view.appendChild(wrap);const actions=document.createElement('div');actions.className='mt-4 flex flex-col sm:flex-row gap-2';const genBtn=document.createElement('button');genBtn.className='flex-1 bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 font-medium';genBtn.textContent='âœ¨ í”„ë¡¬í”„íŠ¸ ìƒì„±';genBtn.onclick=()=>{genPRO(genBtn);scrollTo({top:document.body.scrollHeight,behavior:'smooth'})};actions.appendChild(genBtn);view.appendChild(actions)}

        async function showResult(localPrompt,mode,btn){const originalText=btn.textContent;btn.disabled=true;const loadingMessages=["ì˜ê° ìˆ˜ì‹  ì¤‘...","ì™¸ê³„ì¸ê³¼ êµì‹  ì¤‘... ğŸ‘½","ìš°ì£¼ ê³ ì–‘ì´ì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘... ğŸˆ","ë¸Œë¡œì½œë¦¬ì—ê²Œ ì˜ê²¬ ë¬»ëŠ” ì¤‘... ğŸ¥¦","ë³„ë“¤ì˜ ì†ì‚­ì„ì„ ë“£ëŠ” ì¤‘..."];let idx=0;btn.textContent=loadingMessages[idx];const it=setInterval(()=>{idx=(idx+1)%loadingMessages.length;btn.textContent=loadingMessages[idx]},800);result.innerHTML=`<div class='grid grid-cols-1 md:grid-cols-2 gap-4'><div class='glass rounded-2xl p-4 flex flex-col'><div class="flex justify-between items-center mb-2"><h3 class='text-base font-semibold'>ë¡œì»¬ í”„ë¡¬í”„íŠ¸</h3><button class='copy-btn iconbtn rounded-lg p-1.5 text-sm' data-target="local-prompt">ğŸ“‹</button></div><pre id='local-prompt' class='flex-grow whitespace-pre-wrap text-sm leading-relaxed bg-black/30 rounded-xl p-3 border border-white/10'>${localPrompt}</pre></div><div class='glass rounded-2xl p-4 flex flex-col'><div class="flex justify-between items-center mb-2"><h3 class='text-base font-semibold'>Gemini ë³´ê°• í”„ë¡¬í”„íŠ¸</h3><button class='copy-btn iconbtn rounded-lg p-1.5 text-sm hidden' data-target="gemini-prompt">ğŸ“‹</button></div><div id='gemini-result-wrapper' class='flex-grow min-h-[100px] flex items-center justify-center bg-black/30 rounded-xl p-3 border border-white/10'><div class="loader"></div></div></div></div><div class='mt-4 flex gap-2 justify-end'><button id='savePrompt' class='iconbtn rounded-lg px-3 py-1.5 text-sm'>JSON ì €ì¥</button></div>`;const gemWrap=document.getElementById('gemini-result-wrapper');const gemText=await callGeminiAPI(localPrompt);clearInterval(it);btn.disabled=false;btn.textContent=originalText;gemWrap.innerHTML=`<pre id='gemini-prompt' class='whitespace-pre-wrap text-sm leading-relaxed'>${gemText}</pre>`;gemWrap.parentElement.querySelector('.copy-btn').classList.remove('hidden');document.querySelectorAll('.copy-btn').forEach(b=>{b.onclick=e=>{const id=e.currentTarget.dataset.target;const txt=document.getElementById(id).textContent;navigator.clipboard.writeText(txt).then(()=>showToast('ë³µì‚¬ ì™„ë£Œ!')).catch(()=>showToast('ë³µì‚¬ ì‹¤íŒ¨'))}});document.getElementById('savePrompt').onclick=()=>{const data={mode,ts:Date.now(),localPrompt,geminiPrompt:gemText};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`prompt_${mode}_${Date.now()}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}}
        function genPRO(btn){const blocks=[];['rhythm','bass','harmony','lead','percussion','fx','kick','snare','hihat','clap','cymbal','mix','mast'].forEach(k=>{if(tracks[k]?.length)blocks.push(`${k.toUpperCase()}: ${tracks[k].join(', ')}`)});const p=blocks.filter(Boolean).join(' | ');showResult(p,'pro',btn)}

        // MODE / NAV
        let mode='ai';
        function render(){result.innerHTML="";if(mode==='ai'){renderAI()}else{renderPRO()}}
        segAI.onclick=()=>{mode='ai';segAI.dataset.active=true;segAI.setAttribute('aria-selected','true');segPRO.dataset.active=false;segPRO.setAttribute('aria-selected','false');render()};
        segPRO.onclick=()=>{mode='pro';segAI.dataset.active=false;segAI.setAttribute('aria-selected','false');segPRO.dataset.active=true;segPRO.setAttribute('aria-selected','true');render()};
        navL.onclick=()=>{if(mode==='ai'&&aiState.step>1){aiState.step--;renderAI()}};
        navR.onclick=()=>{if(mode==='ai'&&aiState.step<aiTotal()){aiState.step++;renderAI()}};
        render();
    })();
    </script>
</body>
</html>
