<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPS v4.4 (FX Preview & Mute)</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="apple-touch-icon" href="favicon.svg" />
    <meta name="theme-color" content="#14151b" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --ac: 234 89% 72%; --surf: 0 0% 100%/0.06; --bd: 0 0% 100%/0.12; color-scheme: dark; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        .glass { background: hsl(var(--surf)); -webkit-backdrop-filter: saturate(180%) blur(16px); backdrop-filter: saturate(180%) blur(16px); border: 1px solid hsl(var(--bd)); }
        .chip { padding: .45rem .75rem; border-radius: 12px; font-size: .9rem; border: 1px solid rgba(255, 255, 255, .12); background: rgba(255, 255, 255, .06); transition: .12s; }
        .chip[data-selected=true] { background: rgba(255, 255, 255, .22); border-color: rgba(255, 255, 255, .28); }
        .iconbtn { background: rgba(255, 255, 255, .08); border: 1px solid rgba(255, 255, 255, .14); }
        #bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(1200px 800px at 50% 40%, #0a0a12 0%, #06060a 45%, #010108 100%); cursor: default; }
        .field { display: flex; align-items: center; justify-content: space-between; gap: .75rem; padding: .6rem .9rem; border-radius: 12px; border: 1px solid rgba(255, 255, 255, .12); background: rgba(255, 255, 255, .06); }
        .field span { opacity: .9; }
        .field .mini { opacity: .7; font-size: .85rem; }
        .toast { position: fixed; inset: auto 0 20px 0; display: grid; place-items: center; pointer-events: none; }
        .toast>div { pointer-events: auto; }
        .loader { border: 2px solid rgba(255,255,255,0.2); border-top-color: hsl(var(--ac)); border-radius: 50%; width: 1.5rem; height: 1.5rem; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-neutral-950 text-white min-h-[100svh]">
    <canvas id="bg"></canvas>
    <div class="max-w-5xl mx-auto px-4">
        <header class="glass rounded-2xl px-4 md:px-6 py-4 mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="size-8 rounded-xl bg-white/10 grid place-items-center" aria-hidden="true"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 12c3 0 3-6 6-6s3 12 6 12 3-6 6-6" stroke="hsl(var(--ac))" stroke-width="1.8" stroke-linecap="round" /></svg></div>
                <h1 class="text-lg md:text-xl font-semibold tracking-tight">Suno Prompt Studio</h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="mute-btn" class="iconbtn rounded-lg p-2 text-sm" aria-label="Mute/Unmute audio preview">
                    <svg id="icon-volume-up" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                    <svg id="icon-volume-off" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                </button>
                <div class="inline-flex bg-white/5 rounded-xl p-1" role="tablist" aria-label="Mode switch">
                    <button id="seg-ai" class="px-3 md:px-4 py-1.5 rounded-lg text-sm font-medium data-[active=true]:bg-white/20" data-active="true" aria-selected="true" role="tab">AI ê°€ì´ë“œ</button>
                    <button id="seg-pro" class="px-3 md:px-4 py-1.5 rounded-lg text-sm font-medium" role="tab">í”„ë¡œ ìŠ¤íŠœë””ì˜¤</button>
                </div>
            </div>
        </header>
        <div class="grid min-h-[calc(100svh-120px)] place-items-center group">
            <div class="grid grid-cols-[auto,1fr,auto] items-stretch gap-2 w-full">
                <button id="nav-left" class="opacity-0 group-hover:opacity-100 glass rounded-xl w-12 md:w-14 grid place-items-center" aria-label="ì´ì „ ë‹¨ê³„"><span class="text-2xl">&lt;</span></button>
                <main class="glass rounded-2xl p-4 md:p-6">
                    <div id="progress-wrap" class="mb-4">
                        <div class="h-1.5 bg-white/10 rounded-full overflow-hidden"><div id="progress" class="h-1.5 bg-[hsl(var(--ac))] w-0"></div></div>
                    </div>
                    <section id="view" class="space-y-5"></section>
                    <section id="result" class="mt-5"></section>
                </main>
                <button id="nav-right" class="opacity-0 group-hover:opacity-100 glass rounded-xl w-12 md:w-14 grid place-items-center" aria-label="ë‹¤ìŒ ë‹¨ê³„"><span class="text-2xl">&gt;</span></button>
            </div>
        </div>
        <div id="modal" class="fixed inset-0 hidden items-center justify-center z-50"><div class="absolute inset-0 bg-black/55 backdrop-blur-sm"></div><div class="relative glass rounded-2xl p-5 w-[min(92vw,860px)]"><h3 id="mt" class="text-lg font-semibold text-center"></h3><div class="mt-3"><input id="mSearch" placeholder="ì•…ê¸°, ì‚¬ìš´ë“œ, ì£¼ë²• ë“± ê²€ìƒ‰..." class="w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm" /></div><div id="mg" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto mt-3"></div><div class="mt-4 grid grid-cols-2 gap-2"><button id="mOK" class="bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 text-sm font-medium">ì„ íƒ 0ê°œ ì¶”ê°€</button><button id="mX" class="bg-white/10 hover:bg-white/15 rounded-xl py-2.5 text-sm">ë‹«ê¸°</button></div></div></div>
        <div id="toast" class="toast"></div>
    </div>
    <script>
    (()=>{
        'use strict';
        const PROXY_ENDPOINT='/api/gemini'; // Secure proxy endpoint (no direct API key in client)

        // === Audio FX Preview Setup (Tone.js) ===
        const fxPreviewSynth=new Tone.Synth({oscillator:{type:'sine'},envelope:{attack:0.01,decay:0.2,sustain:0.1,release:0.5}}).toDestination();
        const fxLibrary={
            'Reverb':new Tone.Reverb(1.5).toDestination(),
            'Delay':new Tone.FeedbackDelay('8n',0.5).toDestination(),
            'Phaser':new Tone.Phaser({frequency:0.5,octaves:3,baseFrequency:350}).toDestination(),
            'Chorus':new Tone.Chorus(4,2.5,0.7).toDestination().start(),
            'Compressor':new Tone.Compressor(-24,3).toDestination(),
            'Wah Pedal':new Tone.AutoWah(50,6,-30).toDestination(),
            'Filter Sweep':new Tone.AutoFilter('4n').toDestination().start()
        };

        // === Background Animation ===
        const bg=document.getElementById('bg'),g=bg.getContext('2d');
        let W,H,CX,CY,stars=[];const R=()=>{W=bg.width=innerWidth;H=bg.height=innerHeight;CX=W/2;CY=H/2};addEventListener('resize',R);R();
        function initStars(n=340){stars=new Array(n).fill(0).map(()=>({x:Math.random()*2-1,y:Math.random()*2-1,z:Math.random()*0.8+0.2,len:Math.random()*0.008+0.002}))}initStars();
        const spaceBuddies=[{emoji:'ğŸˆ',t:0,speed:.0022,orbitX:.35,orbitY:.22,orbitZ:.4},{emoji:'ğŸ§‘â€ğŸš€',t:1.5,speed:.0018,orbitX:.4,orbitY:.25,orbitZ:.5},{emoji:'ğŸ•',t:3,speed:.0025,orbitX:.3,orbitY:.2,orbitZ:.3},{emoji:'ğŸ¥¦',t:4.5,speed:.002,orbitX:.38,orbitY:.23,orbitZ:.45}];
        bg.addEventListener('click',e=>{const rect=bg.getBoundingClientRect();const mx=e.clientX-rect.left,my=e.clientY-rect.top;const s=Math.min(W,H)*.55;spaceBuddies.forEach(b=>{if(b.isFlicked)return;const x=Math.cos(b.t)*b.orbitX,y=Math.sin(b.t*0.7)*b.orbitY,z=.58+.13*Math.sin(b.t*b.orbitZ);const sx=CX+(x/z)*s,sy=CY+(y/z)*s,px=16+(1-z)*26;const dist=Math.hypot(mx-sx,my-sy);if(dist<px){b.isFlicked=true;b.flickX=sx;b.flickY=sy;b.flickVx=(Math.random()-0.5)*40;b.flickVy=(Math.random()-0.5)*40}})});
        function drawBuddies(){const s=Math.min(W,H)*.55;spaceBuddies.forEach(b=>{let sx,sy,px;if(b.isFlicked){b.flickX+=b.flickVx;b.flickY+=b.flickVy;b.flickVx*=.99;b.flickVy*=.99;sx=b.flickX;sy=b.flickY;px=30;if(sx<-50||sx>W+50||sy<-50||sy>H+50)b.isFlicked=false}else{b.t+=b.speed;const x=Math.cos(b.t)*b.orbitX,y=Math.sin(b.t*0.7)*b.orbitY,z=.58+.13*Math.sin(b.t*b.orbitZ);sx=CX+(x/z)*s;sy=CY+(y/z)*s;px=16+(1-z)*26}g.save();g.font=`${px}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",system-ui`;g.textAlign='center';g.textBaseline='middle';g.fillText(b.emoji,sx,sy);g.restore()})}
        const SPEED=.006; (function tick(){g.clearRect(0,0,W,H);g.save();g.lineCap='round';const s=Math.min(W,H)*.55;for(const st of stars){st.z-=SPEED;if(st.z<=.02){st.x=Math.random()*2-1;st.y=Math.random()*2-1;st.z=1}const sx=CX+(st.x/st.z)*s,sy=CY+(st.y/st.z)*s,psx=CX+(st.x/(st.z+st.len))*s,psy=CY+(st.y/(st.z+st.len))*s,a=1-Math.min(1,st.z);g.strokeStyle=`rgba(255,255,255,${.12+a*.55})`;g.lineWidth=1+(1-st.z)*1.8;g.beginPath();g.moveTo(psx,psy);g.lineTo(sx,sy);g.stroke()}drawBuddies();g.restore();requestAnimationFrame(tick)})();

        // === DOM Refs & Helpers ===
        const view=document.getElementById('view'),result=document.getElementById('result'),segAI=document.getElementById('seg-ai'),segPRO=document.getElementById('seg-pro'),pl=document.getElementById('progress'),pw=document.getElementById('progress-wrap'),navL=document.getElementById('nav-left'),navR=document.getElementById('nav-right'),modal=document.getElementById('modal'),mt=document.getElementById('mt'),mg=document.getElementById('mg'),mOK=document.getElementById('mOK'),mX=document.getElementById('mX'),mSearch=document.getElementById('mSearch'),toast=document.getElementById('toast');
        const muteBtn=document.getElementById('mute-btn'),volUpIcon=document.getElementById('icon-volume-up'),volOffIcon=document.getElementById('icon-volume-off');
        muteBtn?.addEventListener('click',()=>{Tone.Destination.mute=!Tone.Destination.mute;volUpIcon.classList.toggle('hidden',Tone.Destination.mute);volOffIcon.classList.toggle('hidden',!Tone.Destination.mute)});
        function playFxPreview(effectName){Tone.start();const effect=Object.entries(fxLibrary).find(([key])=>effectName.includes(key))?.[1];if(effect){fxPreviewSynth.connect(effect);fxPreviewSynth.triggerAttackRelease('C5','8n',Tone.now());setTimeout(()=>fxPreviewSynth.disconnect(effect),500)}else{fxPreviewSynth.triggerAttackRelease('C5','8n',Tone.now())}}
        const Chip=(t,sel,fn)=>{const b=document.createElement('button');b.className='chip';b.dataset.selected=sel;b.textContent=t;b.onclick=fn;return b};
        function pills(list,selected,set){const wrap=document.createElement('div');wrap.className='flex flex-wrap gap-2 mt-3';list.forEach(n=>wrap.appendChild(Chip(n,selected.has?selected.has(n):selected===n,e=>{if(selected.has){selected.has(n)?selected.delete(n):selected.add(n);e.target.dataset.selected=selected.has(n)}else{set(n);[...wrap.children].forEach(c=>c.dataset.selected=false);e.target.dataset.selected=true}})));return wrap}
        function showToast(msg){const el=document.createElement('div');el.className='glass rounded-xl px-3 py-2 text-sm max-w-[90vw]';el.textContent=msg;toast.appendChild(el);setTimeout(()=>el.remove(),1500)}
        let ctx=null;function openModal({title,list,multi=false,onDone,placeholder,isFx=false}){ctx={multi,onDone,all:list,sel:new Set,view:new Set(list)};mt.textContent=title;mSearch.placeholder=placeholder||'ê²€ìƒ‰...';renderModal(isFx);modal.classList.add('grid');modal.classList.remove('hidden')}
        function renderModal(isFx=false){mg.innerHTML='';[...ctx.view].forEach(n=>{const b=Chip(n,false,()=>{if(isFx)playFxPreview(n);if(!ctx.multi){ctx.sel=new Set([n]);finishModal();return}const on=b.dataset.selected==='true';b.dataset.selected=!on;on?ctx.sel.delete(n):ctx.sel.add(n);mOK.textContent=`ì„ íƒ ${ctx.sel.size}ê°œ ì¶”ê°€`});mg.appendChild(b)});mSearch.oninput=()=>{const q=mSearch.value.toLowerCase().trim();ctx.view=new Set(ctx.all.filter(x=>x.toLowerCase().includes(q)));renderModal(isFx)};mOK.textContent=ctx.multi?`ì„ íƒ ${ctx.sel.size}ê°œ ì¶”ê°€`:'ì„ íƒ';mOK.onclick=finishModal;mX.onclick=()=>modal.classList.add('hidden')}
        function finishModal(){modal.classList.add('hidden');if(ctx.onDone){ctx.onDone(ctx.multi?Array.from(ctx.sel):Array.from(ctx.sel)[0])}}

        // === Secure Gemini Proxy Call (public mode: no token) ===
        const ACCESS_TOKEN = '';

        async function callGeminiAPI(localPrompt){ if(!localPrompt||!localPrompt.trim()) return 'í”„ë¡¬í”„íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'; try{ const headers={'Content-Type':'application/json'}; if(ACCESS_TOKEN) headers['Authorization']='Bearer '+ACCESS_TOKEN; const res=await fetch(PROXY_ENDPOINT,{method:'POST',headers,body:JSON.stringify({prompt:localPrompt})}); const data=await res.json().catch(()=>({})); if(!res.ok) return `ì„œë²„ ì˜¤ë¥˜: ${data.error||res.status}`; return data.text?.replace(/[*#]/g,'')||'Gemini ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.'; }catch(e){ return 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: '+e.message; } }

        // === Data ===
        const genreMap={'Funk':['Soul Funk','Neo-Soul','G-Funk','Acid Jazz'],'Jazz':['Bebop','Cool Jazz','Swing','Fusion','Big Band'],'K-Pop':['Girl Group Dance','Boy Group Hip Hop','K-Ballad','K-R&B','K-Indie'],'J-Pop':['City Pop','Shibuya-kei','J-Rock','Anime Song','Vocaloid'],'Synthpop':['Synthwave','Futurepop','Darkwave','Chillwave'],'Rock':['Alternative Rock','Indie Rock','Punk Rock','Heavy Metal','Psychedelic Rock'],'Hip Hop':['Trap','Boom Bap','Lo-fi Hip Hop','Drill','G-Funk'],'EDM':['House','Deep House','Tech House','Techno','Trance','Dubstep','Future Bass'],'Drum & Bass':['Liquid DnB','Neurofunk','Jungle','Jump-Up'],'R&B':['Contemporary R&B','Neo-Soul','Alternative R&B','PBR&B','K-R&B'],'Ballad':['Pop Ballad','Rock Ballad','Soul Ballad','K-Ballad']};
        const genreInstrumentMap={'Default':['Drums','Bass','Guitar','Piano','Synthesizer','Strings'],'Funk':['Funky Drums','Slap Bass','Electric Guitar (Wah)','Clavinet','Horns Section','Bongo'],'Soul Funk':['Groovy Drums','Fingerstyle Bass','Electric Piano (Rhodes)','Clean Electric Guitar','Horns Section','Tambourine'],'Neo-Soul':['Dilla-style Drums','Synth Bass','Electric Piano (Rhodes)','Jazzy Guitar Chords','Strings'],'Jazz':['Drums (Brushes)','Contrabass','Piano','Saxophone','Trumpet','Vibraphone'],'K-Pop':['Punchy Drums','Synth Bass','Synthesizer','Pads','Sample Chop','Brass Stabs','Strings','Electric Guitar'],'Synthpop':['Drum Machine','Arp Synth','Synth Pad','Synth Bass','Synth Lead'],'Rock':['Acoustic Drums','Bass Guitar','Distorted Electric Guitar','Rhythm Guitar'],'Hip Hop':['808 Drum Machine','Sub Bass','Sample','Synth Pad','Piano','Congas'],'EDM':['909 Drum Machine','Pluck Lead','Supersaw Pad','Synth Bass'],'Drum & Bass':['Breakbeat Drums','Reese Bass','Sub Bass','Atmos Pad','Synth Lead','Amen Break'],'R&B':['Trap Drums','808 Bass','Electric Piano','Synth Pad','Vocal Ad-libs','Tambourine'],'Ballad':['Piano','String Section','Acoustic Guitar','Slow Drums','Fretless Bass','Cello']};
        const genreFxMap={'Default':['Reverb','Delay','Compressor'],'Funk':['Wah Pedal','Phaser','Spring Reverb'],'Jazz':['Plate Reverb','Tape Delay'],'EDM':['Sidechain Compressor','White Noise','Downlifter','Riser','Filter Sweep'],'Drum & Bass':['Heavy Compressor','Filter Sweep','Reverb Tail'],'Synthpop':['Chorus','Gated Reverb','Arpeggiator']};
        const fullInstrumentList=[...new Set(Object.values(genreInstrumentMap).flat())];
        const fullFxList=[...new Set(Object.values(genreFxMap).flat())];

        // === AI Wizard State ===
                const aiState={step:1,genre:'Funk',sub:'Soul Funk',core:new Set(['Funky Drums','Slap Bass']),fx:new Set(),vocal:'Female Vocal',keywords:'',mood:new Set(['Warm','Dreamy']),bpm:110,structure:new Set(['Intro','Verse','Chorus']),bracket:true};

                function ensureMin(set, candidates, min=5){
                    for(const c of candidates){ if(set.size>=min) break; set.add(c); }
                }
                // initial minimum fill
                ensureMin(aiState.core, genreInstrumentMap['Funk']||genreInstrumentMap['Default']);
        function aiTotal(){return 7}
        function field(label,value,onclick){const d=document.createElement('button');d.type='button';d.className='field w-full text-left';d.onclick=onclick;d.innerHTML=`<span>${label}</span><span class="mini">${value}</span>`;return d}
    function renderAI(){view.innerHTML='';pw.style.display='block';pl.style.width=((aiState.step/aiTotal())*100)+'%';navL.style.visibility=aiState.step===1?'hidden':'visible';navR.style.visibility=aiState.step===aiTotal()?'hidden':'visible';const card=document.createElement('div');card.className='space-y-4';const H=t=>{const h=document.createElement('h3');h.className='text-base font-semibold';h.textContent=t;return h};if(aiState.step===1){card.appendChild(H('Step 1: ì¥ë¥´ ì„ íƒ'));card.appendChild(field(`ì¥ë¥´`,`${aiState.genre} @${aiState.bpm}bpm`,()=>openModal({title:'GENRE ì„ íƒ',list:Object.keys(genreMap),multi:false,placeholder:'ì¥ë¥´ ê²€ìƒ‰...',onDone:pick=>{if(!pick)return;aiState.genre=pick;aiState.sub=genreMap[pick][0];aiState.bpm=(pick==='Drum & Bass')?174:110;aiState.core=new Set(genreInstrumentMap[pick]||genreInstrumentMap['Default']);ensureMin(aiState.core, genreInstrumentMap[pick]||genreInstrumentMap['Default']);renderAI()}})))} if(aiState.step===2){card.appendChild(H('Step 2: ì„¸ë¶€ ì¥ë¥´ ì„ íƒ'));card.appendChild(field('ì„¸ë¶€ ì¥ë¥´',aiState.sub,()=>openModal({title:'SUBGENRE ì„ íƒ',list:genreMap[aiState.genre],multi:false,placeholder:'ì„¸ë¶€ ì¥ë¥´ ê²€ìƒ‰...',onDone:pick=>{if(!pick)return;aiState.sub=pick;aiState.core=new Set(genreInstrumentMap[pick]||genreInstrumentMap[aiState.genre]||genreInstrumentMap['Default']);ensureMin(aiState.core, genreInstrumentMap[pick]||genreInstrumentMap['Default']);renderAI()}})))} if(aiState.step===3){card.appendChild(H('Step 3: í•µì‹¬ ì•…ê¸° ë° í¼ì»¤ì…˜ (ìµœì†Œ 5ê°œ ìë™ ì„ íƒ)'));card.appendChild(pills(Array.from(aiState.core),aiState.core));const addBtn=document.createElement('button');addBtn.className='chip bg-[hsl(var(--ac))]/20 text-[hsl(var(--ac))] border-[hsl(var(--ac))]/50 mt-3';addBtn.textContent='+ ê²€ìƒ‰í•˜ì—¬ ì•…ê¸° ì¶”ê°€';addBtn.onclick=()=>openModal({title:'ì „ì²´ ì•…ê¸° ë¼ì´ë¸ŒëŸ¬ë¦¬',list:fullInstrumentList,multi:true,placeholder:'ì•…ê¸°, ì‚¬ìš´ë“œ, ì£¼ë²• ë“± ê²€ìƒ‰...',onDone:picks=>{if(picks&&picks.length){picks.forEach(p=>aiState.core.add(p));ensureMin(aiState.core, fullInstrumentList);renderAI()}}});card.appendChild(addBtn)} if(aiState.step===4){card.appendChild(H('Step 4: FX (ìŒí–¥ íš¨ê³¼)'));const items=genreFxMap[aiState.genre]||genreFxMap['Default'];card.appendChild(pills(items,aiState.fx));const addBtn=document.createElement('button');addBtn.className='chip bg-[hsl(var(--ac))]/20 text-[hsl(var(--ac))] border-[hsl(var(--ac))]/50 mt-3';addBtn.textContent='+ FX ê²€ìƒ‰ ë° ë¯¸ë¦¬ë“£ê¸°';addBtn.onclick=()=>openModal({title:'ì „ì²´ FX ë¼ì´ë¸ŒëŸ¬ë¦¬',list:fullFxList,multi:true,placeholder:'ë¦¬ë²„ë¸Œ, ë”œë ˆì´ ë“± ê²€ìƒ‰...',isFx:true,onDone:picks=>{if(picks&&picks.length){picks.forEach(p=>aiState.fx.add(p));renderAI()}}});card.appendChild(addBtn)} if(aiState.step===5){card.appendChild(H('Step 5: ë³´ì»¬ & í‚¤ì›Œë“œ'));const row=document.createElement('div');row.className='grid grid-cols-1 md:grid-cols-2 gap-3 mt-2';const vocWrap=field('ë³´ì»¬',aiState.vocal,()=>openModal({title:'VOCAL ì„ íƒ',list:['Male Vocal','Female Vocal','Instrumental'],multi:false,onDone:pick=>{if(pick)aiState.vocal=pick;renderAI()}}));const kw=document.createElement('input');kw.placeholder='ë…¸ë˜ ì£¼ì œ í‚¤ì›Œë“œ';kw.value=aiState.keywords||'';kw.className='w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2';kw.oninput=()=>aiState.keywords=kw.value;row.appendChild(vocWrap);row.appendChild(kw);card.appendChild(row)} if(aiState.step===6){card.appendChild(H('Step 6: ë¬´ë“œ, BPM, êµ¬ì¡°'));card.appendChild(pills(['Warm','Dreamy','Groovy','Dark','Uplifting'],aiState.mood));const ctrl=document.createElement('div');ctrl.className='grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3';ctrl.innerHTML=`<label class='block text-sm'>BPM <input id='bpm' type='number' value='${aiState.bpm}' class='mt-1 w-full bg-white/5 border border-white/10 rounded-xl px-3 py-2'></label><label class='block text-sm'>êµ¬ì¡°</label>`;card.appendChild(ctrl);ctrl.querySelector('#bpm').oninput=e=>aiState.bpm=+e.target.value||110;card.appendChild(pills(['Intro','Verse','Chorus','Bridge','Outro'],aiState.structure))} if(aiState.step===7){card.appendChild(H('Step 7: í”„ë¡¬í”„íŠ¸ ìƒì„±'));const btn=document.createElement('button');btn.className='w-full bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 font-medium';btn.textContent='âœ¨ í”„ë¡¬í”„íŠ¸ ìƒì„±';btn.onclick=()=>{const prompt=buildAIPrompt();showResult(prompt,'ai',btn)};card.appendChild(btn)} view.appendChild(card)}
        function buildAIPrompt(){const join=s=>Array.from(s||[]).join(', ');const nonEmpty=a=>a.filter(Boolean);const head=`GENRE: ${aiState.genre}/${aiState.sub} @${aiState.bpm}bpm`;const lines=[head];const core=join(aiState.core);if(core)lines.push(`CORE: ${core}`);const fx=join(aiState.fx);if(fx)lines.push(`FX: ${fx}`);if(aiState.vocal&&aiState.vocal!=='Instrumental')lines.push(`VOCAL: ${aiState.vocal}`);const mood=join(aiState.mood);if(mood)lines.push(`MOOD: ${mood}`);if(aiState.structure.size)lines.push(`STRUCT: ${Array.from(aiState.structure).map(s=>`[${s}]`).join(' ')}`);if(aiState.keywords&&aiState.keywords.trim())lines.push(`THEME: ${aiState.keywords.trim()}`);return nonEmpty(lines).join(' | ')}

        // === PRO Mode ===
        const tracks={rhythm:[],bass:[],harmony:[],lead:[],percussion:[],fx:[],kick:[],snare:[],hihat:[],clap:[],cymbal:[],mix:[],mast:[]};
        const lib={rhythm:['DnB 174 Straight','Breakbeat 130bpm'],bass:['Electric Bass','Synth Bass'],harmony:['Piano','Synth Pad'],lead:['Lead Synth'],percussion:['Tambourine','Shaker'],fx:['Riser'],kick:['Acoustic Kick'],snare:['Acoustic Snare'],hihat:['Closed Hat'],clap:['Handclap'],cymbal:['Crash'],mix:['Sidechain: Kick-Bass','Drum BusComp: Punchy'],mast:['LUFS: -8','Width: 15%']};
        function openKit(cat){openModal({title:`${cat.toUpperCase()} í•­ëª© ì„ íƒ`,list:lib[cat]||[],multi:true,onDone:arr=>{(tracks[cat]||(tracks[cat]=[]));arr.forEach(n=>tracks[cat].push(n));renderPRO()}})}
        function box(cat,label){const d=document.createElement('div');d.className='glass rounded-2xl p-4';d.innerHTML=`<div class='flex items-center justify-between mb-2'><h4 class='font-medium'>${label}</h4><button class='add bg-[hsl(var(--ac))]/20 hover:bg-[hsl(var(--ac))]/30 rounded-lg px-3 py-1.5 text-sm'>+ ì¶”ê°€</button></div><div class='space-y-2 list'></div>`;const list=d.querySelector('.list');d.querySelector('.add').onclick=()=>openKit(cat);const refresh=()=>{list.innerHTML='';(tracks[cat]||[]).forEach((n,i)=>{const r=document.createElement('div');r.className='flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-3 py-2';r.innerHTML=`<span>${n}</span>`;const del=document.createElement('button');del.className='text-red-300/90 hover:text-red-200 text-sm';del.textContent='ì‚­ì œ';del.onclick=()=>{tracks[cat].splice(i,1);refresh()};r.appendChild(del);list.appendChild(r)})};refresh();return d}
        function renderPRO(){view.innerHTML='';pw.style.display='none';navL.style.visibility='hidden';navR.style.visibility='hidden';const wrap=document.createElement('div');wrap.className='space-y-6';wrap.innerHTML+=`<h3 class="text-lg font-semibold text-center text-neutral-400 -mb-2">ë“œëŸ¼ & ë¦¬ë“¬ ì„¹ì…˜</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="pro-row-1"></div>`;wrap.innerHTML+=`<h3 class="text-lg font-semibold text-center text-neutral-400 mt-6 -mb-2">ì•…ê¸° & FX ì„¹ì…˜</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="pro-row-2"></div>`;wrap.innerHTML+=`<h3 class="text-lg font-semibold text-center text-neutral-400 mt-6 -mb-2">í¸ê³¡, ë¯¹ì‹± & ë§ˆìŠ¤í„°ë§</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="pro-row-3"></div>`;['kick','snare','hihat','clap','cymbal','percussion'].forEach(k=>wrap.querySelector('#pro-row-1').appendChild(box(k,{kick:'í‚¥',snare:'ìŠ¤ë„¤ì–´',hihat:'í•˜ì´í–‡',clap:'í´ë©',cymbal:'ì‹¬ë²Œ',percussion:'í¼ì»¤ì…˜'}[k],k)));['rhythm','bass','harmony','lead','fx'].forEach(k=>wrap.querySelector('#pro-row-2').appendChild(box(k,{rhythm:'ë¦¬ë“¬',bass:'ë² ì´ìŠ¤',harmony:'í•˜ëª¨ë‹ˆ',lead:'ë¦¬ë“œ',fx:'FX'}[k],k)));['mix','mast'].forEach(k=>wrap.querySelector('#pro-row-3').appendChild(box(k,{mix:'ë¯¹ì‹±',mast:'ë§ˆìŠ¤í„°ë§'}[k],k)));view.appendChild(wrap);const actions=document.createElement('div');actions.className='mt-6 flex flex-col sm:flex-row gap-2';const genBtn=document.createElement('button');genBtn.className='flex-1 bg-[hsl(var(--ac))]/90 hover:bg-[hsl(var(--ac))] rounded-xl py-2.5 font-medium';genBtn.textContent='âœ¨ í”„ë¡¬í”„íŠ¸ ìƒì„±';genBtn.onclick=()=>{genPRO(genBtn);scrollTo({top:document.body.scrollHeight,behavior:'smooth'})};actions.appendChild(genBtn);view.appendChild(actions)}
        async function showResult(localPrompt,mode,btn){const originalText=btn.textContent;btn.disabled=true;const loadingMessages=['ì˜ê° ìˆ˜ì‹  ì¤‘...','ì™¸ê³„ì¸ê³¼ êµì‹  ì¤‘... ğŸ‘½','ìš°ì£¼ ê³ ì–‘ì´ì—ê²Œ ë¬¼ì–´ë³´ëŠ” ì¤‘... ğŸˆ','ë¸Œë¡œì½œë¦¬ì—ê²Œ ì˜ê²¬ ë¬»ëŠ” ì¤‘... ğŸ¥¦','ë³„ë“¤ì˜ ì†ì‚­ì„ì„ ë“£ëŠ” ì¤‘...'];let idx=0;btn.textContent=loadingMessages[idx];const it=setInterval(()=>{idx=(idx+1)%loadingMessages.length;btn.textContent=loadingMessages[idx]},800);result.innerHTML=`<div class='grid grid-cols-1 md:grid-cols-2 gap-4'><div class='glass rounded-2xl p-4 flex flex-col'><div class="flex justify-between items-center mb-2"><h3 class='text-base font-semibold'>ë¡œì»¬ í”„ë¡¬í”„íŠ¸</h3><button class='copy-btn iconbtn rounded-lg p-1.5 text-sm' data-target="local-prompt">ğŸ“‹</button></div><pre id='local-prompt' class='flex-grow whitespace-pre-wrap text-sm leading-relaxed bg-black/30 rounded-xl p-3 border border-white/10'>${localPrompt}</pre></div><div class='glass rounded-2xl p-4 flex flex-col'><div class="flex justify-between items-center mb-2"><h3 class='text-base font-semibold'>Gemini ë³´ê°• í”„ë¡¬í”„íŠ¸</h3><button class='copy-btn iconbtn rounded-lg p-1.5 text-sm hidden' data-target="gemini-prompt">ğŸ“‹</button></div><div id='gemini-result-wrapper' class='flex-grow min-h-[100px] flex items-center justify-center bg-black/30 rounded-xl p-3 border border-white/10'><div class="loader"></div></div></div></div><div class='mt-4 flex gap-2 justify-end'><button id='savePrompt' class='iconbtn rounded-lg px-3 py-1.5 text-sm'>JSON ì €ì¥</button></div>`;const gemWrap=document.getElementById('gemini-result-wrapper');const gemText=await callGeminiAPI(localPrompt);clearInterval(it);btn.disabled=false;btn.textContent=originalText;gemWrap.innerHTML=`<pre id='gemini-prompt' class='whitespace-pre-wrap text-sm leading-relaxed'>${gemText}</pre>`;gemWrap.parentElement.querySelector('.copy-btn').classList.remove('hidden');document.querySelectorAll('.copy-btn').forEach(b=>{b.onclick=e=>{const id=e.currentTarget.dataset.target;const txt=document.getElementById(id).textContent;navigator.clipboard.writeText(txt).then(()=>showToast('ë³µì‚¬ ì™„ë£Œ!')).catch(()=>showToast('ë³µì‚¬ ì‹¤íŒ¨'))}});document.getElementById('savePrompt').onclick=()=>{const data={mode,ts:Date.now(),localPrompt,geminiPrompt:gemText};const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`prompt_${mode}_${Date.now()}.json`;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url)}}
        function genPRO(btn){const blocks=[];['kick','snare','hihat','clap','cymbal','percussion','rhythm','bass','harmony','lead','fx','mix','mast'].forEach(k=>{if(tracks[k]?.length)blocks.push(`${k.toUpperCase()}: ${tracks[k].join(', ')}`)});const p=blocks.filter(Boolean).join(' | ');showResult(p,'pro',btn)}

        // Mode handlers
        let mode='ai';
        function setActiveTab(target){segAI.removeAttribute('data-active');segPRO.removeAttribute('data-active');target.setAttribute('data-active','true')}
        function render(){result.innerHTML='';if(mode==='ai'){renderAI()}else{renderPRO()}}
        segAI.onclick=()=>{if(mode==='ai')return;mode='ai';setActiveTab(segAI);segAI.setAttribute('aria-selected','true');segPRO.setAttribute('aria-selected','false');render()};
        segPRO.onclick=()=>{if(mode==='pro')return;mode='pro';setActiveTab(segPRO);segAI.setAttribute('aria-selected','false');segPRO.setAttribute('aria-selected','true');render()};
        setActiveTab(segAI);
        navL.onclick=()=>{if(mode==='ai'&&aiState.step>1){aiState.step--;renderAI()}};
        navR.onclick=()=>{if(mode==='ai'&&aiState.step<aiTotal()){aiState.step++;renderAI()}};
        render();
    })();
    </script>
</body>
</html>
